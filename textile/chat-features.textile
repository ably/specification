---
title: Chat Features
section: client-lib-development-guide
index: 55
jump_to:
  Help with:
    - Chat Features Overview#overview
---

h2(#overview). Overview

This document outlines the feature specification for the Ably Chat product.

The key words "must", "must not", "required", "shall", "shall not", "should", "should not", "recommended",  "may", and "optional" (whether lowercased or uppercased) in this document are to be interpreted as described in "RFC 2119":https://tools.ietf.org/html/rfc2119.

The over-the-wire protocol for Chat, as well as implementation details, may be found on the chat protocol page.

h2(#overview). Chat Specification Version

* @(CHA-V1)@ **Specification Version**: This document defines the Ably chat library features specification ('features spec').
** @(CHA-V1a)@ The current version of the Chat library feature specification is version @0.1.0@.

h2(#general). General Principles

* @(CHA-GP1)@ As far as is practicable, the implementation details such as underlying Realtime Channels should be hidden from the public API. This allows developers to interact with Chat without having to understand many low-level primitives.
* @(CHA-GP2)@ The public API should avoid implicit operations as a side-effect to some other operation. For example, adding a subscriber to messages in a Chat Room should not automatically trigger that Room to attach. This is in contrast to the current core SDKs. Avoiding side-effects provides a clean, easy to understand API.
** @(CHA-GP2a)@ @[Testable]@ Whenever the Chat SDK fetches a realtime channel, it must do so with the @attachOnSubscribe@ channel option set to @false@.
* @(CHA-GP3)@ Wherever possible, Chat features should be exposed in the public API as properties of their parent. For example, @messages@ would be considered a property of a @room@ object. This allows for greater composability and extensibility in the future.
* @(CHA-GP4)@ Avoid overloading methods and optional parameters. Prefer object-type parameters wherever practical and idiomatic.

h2(#initialization). Initialization

* @(CHA-IN1)@ In order to initialize a chat client, the user must supply an instance of @RealtimeClient@. Upon initialization, the chat client must configure this client in order to allow Ably to track usage of the Chat SDK, as described in the sub-items below.
** @(CHA-IN1a)@ @[Testable]@ Upon initialization of the chat client, it must create a wrapper SDK proxy client by calling @createWrapperSDKProxy@ on the @RealtimeClient@.
** @(CHA-IN1b)@ @[Testable]@ When creating the @CHA-IN1a@ wrapper SDK proxy client, the chat client must pass a @WrapperSDKProxyOptions@ whose @agents@ describe the Chat SDK and its version. For example, @{ "agents": { "chat-js": "1.0.1" } }@.
** @(CHA-IN1c)@ SDK authors must ensure that they have registered the agents used by @CHA-IN1b@ in the common repository, per "@RSC7d5@":../features#RSC7d5.
** @(CHA-IN1d)@ @[Testable]@ The chat client must use the wrapper SDK proxy client created in @CHA-IN1a@ as the realtime client on which it performs all subsequent actions (for example, fetching channels or calling @#request@).

h2(#rooms). Rooms

h3(#rooms-general). General Information

A Room is the atomic unit of Chat. All chat operations are performed in the context of a room that a client is currently attached to. As the Room is the atomic unit, its state should be considered as the combination of the states of underlying resources.

h3(#connection-status). Connection Status

The connection status of the Chat client closely reflects the status of the underlying Realtime client, but with one major difference. When a disconnect takes place, we assume that it is transient for a certain amount of time, before eventually emitting an event. This prevents customers being unnecessarily sent connection status updates if the connection recovers quickly (e.g. when going through a tunnel).

* @(CHA-CS1)@ Every chat client has a @status@, which describes the current status of the connection.
** @(CHA-CS1a)@ The @INITIALIZED@ status is a default status when the realtime client is first initialized. This value may be seen if the realtime client doesn't have autoconnect turned on.
** @(CHA-CS1b)@ The @CONNECTING@ status is used when the client is in the process of connecting to Ably servers.
** @(CHA-CS1c)@ The @CONNECTED@ status is used when the client connected to Ably servers.
** @(CHA-CS1d)@ The @DISCONNECTED@ status is used when the client is not currently connected to Ably servers. This state may be temporary as the underlying Realtime SDK seeks to reconnect.
** @(CHA-CS1e)@ The @SUSPENDED@ status is used when the client is in an extended state of disconnection, but will attempt to reconnect.
** @(CHA-CS1f)@ The @FAILED@ status is used when the client is disconnected from the Ably servers due to some non-retriable failure such as authentication failure. It will not attempt to reconnect.
* @(CHA-CS2)@ The connection must expose its current status.
** @(CHA-CS2a)@ @[Testable]@ The chat client must expose its current connection status, a single value from the list in @CHA-CS1@.
** @(CHA-CS2b)@ @[Testable]@ The chat client must expose the latest error, if any, associated with its current status.
* @(CHA-CS3)@ @[Testable]@ The initial status and error of the connection must be whatever status the realtime client returns whilst the connection status object is constructed.
* @(CHA-CS4)@ The chat client must allow its connection status to be observed by clients.
** @(CHA-CS4a)@ @[Testable]@ Connection status update events must contain the newly entered connection status.
** @(CHA-CS4b)@ @[Testable]@ Connection status update events must contain the previous connection status.
** @(CHA-CS4c)@ @[Testable]@ Connection status update events must contain the connection error (if any) that pertains to the newly entered connection status.
** @(CHA-CS4d)@ @[Testable]@ Clients must be able to register a listener for connection status events and receive such events.
** @(CHA-CS4e)@ @[Testable]@ Clients must be able to unregister a listener for connection status events and from that point onwards, cease to receive such events on that listener.
** @(CHA-CS4f)@ @[Testable]@ Clients must be able to unregister all listeners for connections status events, after which point, all currently registered listeners will cease to receive such events.
* @(CHA-CS5)@ The chat client must monitor the underlying realtime connection for connection status changes.
** @(CHA-CS5a)@ The chat client must suppress transient disconnection events. It is not uncommon for Ably servers to perform connection shedding to balance load, or due to retiring. Clients should not need to concern themselves with transient events.
*** @(CHA-CS5a1)@ @[Testable]@ If the realtime connection status transitions from @CONNECTED@ to @DISCONNECTED@, the chat client connection status must not change. A 5 second transient disconnect timer shall be started.
*** @(CHA-CS5a2)@ @[Testable]@ If a transient disconnect timer is active and the realtime connection status changes to @DISCONNECTED@ or @CONNECTING@, the library must not emit a status change.
*** @(CHA-CS5a3)@ @[Testable]@ If a transient disconnect timer is active and the realtime connections status changes to @CONNECTED@, @SUSPENDED@ or @FAILED@, the library shall cancel the transient disconnect timer. The superseding status change shall be emitted.
*** @(CHA-CS5a4)@ @[Testable]@ If a transient disconnect timer expires, the library shall emit a connection status change event. This event must contain the current status of timer expiry, along with the @original@ error that initiated the transient disconnect timer.
** @(CHA-CS5b)@ @[Testable]@ Not withstanding @CHA-CS5a@. If a connection state event is observed from the underlying realtime library, the client must emit a status change event. The current status of that event shall reflect the status change in the underlying realtime library, along with the accompanying error.

h3(#rooms-status). Room Statuses

The status of any given Chat Room is the combination of the states of all of its constituent contributors. For more information on this, see "@Room Lifecycle@":#rooms-lifecycle.

* @(CHA-RS1)@ Every room has a @status@, which describes the current status of the room.
** @(CHA-RS1a)@ The @INITIALIZED@ status is the initial status before any attachment operations have taken place.
** @(CHA-RS1b)@ The @ATTACHING@ status is used when the room is in the process of attaching to Ably.
** @(CHA-RS1c)@ The @ATTACHED@ status means that the room is fully connected to Ably and functioning normally.
** @(CHA-RS1d)@ The @DETACHING@ status is used when the room is in the process of detaching from Ably.
** @(CHA-RS1e)@ The @DETACHED@ status means that the room has been detached from Ably by a user-initiated request. It will not attempt to re-connect without explicit intervention.
** @(CHA-RS1f)@ The @SUSPENDED@ status is when the room has been detached from Ably for an extended period of time. The room will periodically attempt to reconnect.
** @(CHA-RS1g)@ The @FAILED@ status means that something has gone wrong with the room (such as lack of permissions). The room will not attempt to connect to Ably and will require user intervention.
** @(CHA-RS1h)@ The @RELEASING@ status means that the room is being released and the underlying resources are being cleaned up.
** @(CHA-RS1i)@ The @RELEASED@ status means that the room has been cleaned up and the object can no longer be used.
** @(CHA-RS1j)@ The @INITIALIZING@ status is reserved for React uses, and should not be included outside of the JS/TS SDK.
* @(CHA-RS2)@ A room must expose its current status.
** @(CHA-RS2a)@ @[Testable]@ A room must expose its current status, a single value from the list provided above.
** @(CHA-RS2b)@ A room must expose the latest error, if any, associated with its current status.
*** @(CHA-RS2b1)@ @[Testable]@ If an error is associated with the current status, then this must be exposed.
*** @(CHA-RS2b2)@ @[Testable]@ If there is no error is associated with the current status, then the room status should not expose any errors.
* @(CHA-RS3)@ @[Testable]@ A newly created room must have a current status of @INITIALIZED@.
* @(CHA-RS4)@ A room must allow changes to room status to be observed by clients.
** @(CHA-RS4a)@ @[Testable]@ Room status update events must contain the newly entered room status.
** @(CHA-RS4b)@ @[Testable]@ Room status update events must contain the previous room status.
** @(CHA-RS4c)@ @[Testable]@ Room status update events must not contain an error, where that error pertains to the current status.
** @(CHA-RS4d)@ @[Testable]@ Room status update events must contain an error, where that error pertains to the current status.
** @(CHA-RS4e)@ @[Testable]@ Clients must be able to register a listener for room status updates and receive such events.
** @(CHA-RS4f)@ @[Testable]@ Clients must be able to unregister a listener for room status updates and from that point onwards, cease to receive such events on that listener only.
** @(CHA-RS4g)@ @[Testable]@ Clients must be able to unregister all listeners for room status updates and from that point onwards, cease to receive such events on all listeners.

h3(#rooms-lifecycle). Room Lifecycle

Rooms are considered the atomic unit of chat and comprise of potentially multiple underlying realtime channels. The status of the room is, broadly speaking, the combination of the respective underlying channel states (the rooms @contributors@). We present one unified status, rather than statuses for multiple individual features, as this is easier for developers to reason about.

Chat features are spread across multiple Realtime Channels. For the purpose of this section, a @contributor@ is a feature in Chat that is considered as part of the overall room status, as well as its lifecycle. A @contributor@ might share its realtime channel with another (e.g. messages and occupancy), or it might be entirely standalone (room reactions). In that sense, implementations of Room Lifecycle @MUST@ make no assumptions over which realtime channels are in use or being shared, and treat every @contributor@ as being entirely standalone.

There are four room lifecycle operations: @ATTACH@, @DETACH@, @RELEASE@ and @RETRY@. @RETRY@ is an internal-only operation. These operations are intended to be atomic and not interfere with each other, in order to preserve chat room integrity. How this is achieved is described in further specification items.

Discontinuities in Realtime connections happen - whereby continuity of message delivery is disrupted. Therefore each feature may also experience discontinuity events - where the user may need to take some action to restore continuity in their application. In Chat, we explicitly tell the user when there's a discontinuity, rather than require them to implement the monitoring themselves. As such are events are normally associated with something going wrong, we only want to tell them that a discontinuity happened when everything has fixed itself. Therefore, when a discontinuity is noticed by us, we might not notify the user immediately, instead preferring to hold the event in pending until the right time. For more information on how to handle discontinuities, consult the room lifecycle specification points.

In the same sense as discontinuities, sometimes connections drop momentarily - due to connection balancing by the Realtime system or simply bad internet connections. In Chat we try to avoid broadcasting these transient disconnects to users, so long as they don't affect continuity. Therefore, we tend to handle disconnections or detachments optimistically at first - hoping that they will resolve themselves, and only informing the user when it is clear that it may take longer than anticipated.

h4(#rooms-lifecycle-operations). Room Lifecycle Operations

* @(CHA-RL1)@ A room must be explicitly attached via the @ATTACH@ operation.
** @(CHA-RL1a)@ @[Testable]@ If the room is already in the @ATTACHED@ status, then this operation is no-op.
** @(CHA-RL1j)@ This specification point has been removed.
** @(CHA-RL1b)@ @[Testable]@ If the room is in the @RELEASING@ status, the operation shall be rejected with an @ErrorInfo@ with the @RoomIsReleasing@ error code from the "chat-specific error codes":#error-codes.
** @(CHA-RL1c)@ @[Testable]@ If the room is in the @RELEASED@ status, the operation shall be rejected with an @ErrorInfo@ with the @RoomIsReleased@ error code from the "chat-specific error codes":#error-codes.
** @(CHA-RL1d)@ @[Testable]@ If a room lifecycle operation is already in progress, this operation shall wait until the current operation completes before continuing, subject to @CHA-RL7@.
** @(CHA-RL1e)@ @[Testable]@ Notwithstanding the above points, when the attachment operation begins, the room shall be transitioned to the @ATTACHING@ status.
** @(CHA-RL1f)@ @[Testable]@ The underlying @contributors@ will have their Realtime Channels attached in sequence - an attach call must complete successfully before the next is started.
** @(CHA-RL1g)@ When all @contributors@ Realtime Channels successfully attach (the calls to @attach()@ complete successfully), the operation is now complete and the room is considered attached.
*** @(CHA-RL1g1)@ @[Testable]@ The room status shall be transitioned to @ATTACHED@.
*** @(CHA-RL1g2)@ @[Testable]@ Any contributors to rooms that have a pending discontinuity event against them, must be notified of this fact, using the error that caused the original discontinuity. These are then cleared to prevent double-notification.
*** @(CHA-RL1g3)@ @[Testable]@ Any transient disconnect timeouts shall be cleared.
** @(CHA-RL1h)@ If a one of the @contributors@ Realtime Channels fails to attach (i.e. the call to @attach()@ returns an error), then the operation has failed and must be rolled back. The procedure to roll back is described in subsequent points.
*** @(CHA-RL1h1)@ This clause has been deleted.
*** @(CHA-RL1h2)@ @[Testable]@ If the underlying Realtime Channel entered the @SUSPENDED@ state (i.e. the @attach()@ operation fails and upon subsequently checking the channel state, it is @SUSPENDED@), then the room status will transition to @SUSPENDED@. The state transition @ErrorInfo@ will use the error from the realtime channels `attach()` as the @cause@. The status code shall be @500@ and the error code whatever attachment error code corresponds to the feature that has failed, per "the error code list":#error-codes.
*** @(CHA-RL1h3)@ @[Testable]@ When the room enters the @SUSPENDED@ status as a result of @CHA-RL1h2@ the @attach()@ operation shall fail using the error from @CHA-RL1h2@. The room lifecycle shall asynchronously (non-blocking to the @ATTACH@ operation) enter the recovery loop (per "@CHA-RL5@":#CHA-RL5) and attempt to re-establish attachment.
*** @(CHA-RL1h4)@ @[Testable]@ If the underlying Realtime Channel entered the @FAILED@ state, then the room status will transition to @FAILED@, using the error from the realtime channels `attach()` call as the @cause@ field of the @ErrorInfo@. The status code shall be @500@ and the error code whatever attachment error code corresponds to the feature that has failed, per "the error code list":#error-codes. The same error shall be thrown as the result of the @ATTACH@ operation.
*** @(CHA-RL1h5)@ @[Testable]@ When the room enters the @FAILED@ status as a result of @CHA-RL1h4@, asynchronously with respect to @CHA-RL1h4@, then the room will detach all channels that are not in the @FAILED@ state.
*** @(CHA-RL1h6)@ @[Testable]@ If, when performing @CHA-RL1h5@, a channel fails to detach on command, then the detach operation will be repeated until such a time that all channels have detached successfully.
** @(CHA-RL1i)@ This specification point has been removed. It was superseded by CHA-RC1f.
*** @(CHA-RL1i1)@ This specification point has been removed. It was made redundant by the introduction of @CHA-RC1@.
* @(CHA-RL2)@ A room must be explicitly detached via the @DETACH@ operation.
** @(CHA-RL2a)@ @[Testable]@ If the room status is already @DETACHED@, then this operation is a no-op.
** @(CHA-RL2b)@ @[Testable]@ If the room is in the @RELEASING@ status, the operation shall be rejected with an @ErrorInfo@ with the @RoomIsReleasing@ error code from the "chat-specific error codes":#error-codes.
** @(CHA-RL2c)@ @[Testable]@ If the room is in the @RELEASED@ status, the operation shall be rejected with an @ErrorInfo@ with the @RoomIsReleased@ error code from the "chat-specific error codes":#error-codes.
** @(CHA-RL2d)@ @[Testable]@ If the room is in the @FAILED@ status, the operation shall be rejected with an @ErrorInfo@ with @RoomInFailedState@ error code from the "chat-specific error codes":#error-codes.
** @(CHA-RL2e)@ @[Testable]@ Notwithstanding the above points, when the detachment operation begins, the room shall be transitioned to the @DETACHING@ status and any transient disconnect timeouts cleared.
** @(CHA-RL2f)@ @[Testable]@ The underlying @contributors@ Realtime Channels will be detached in sequence - a call to @detach()@ must complete before the next call begins.
** @(CHA-RL2g)@ @[Testable]@ If all channel detachments complete successfully (all calls @detach()@ return successfully), then the room shall transition to the @DETACHED@ status.
** @(CHA-RL2h)@ If during detachment, a channel fails to detach (i.e. the call to @detach()@ returns an error), different operations are performed based on the nature of the detach.
*** @(CHA-RL2h1)@ @[Testable]@ If a channel enters the @FAILED@ state during detachment (i.e. the @detach()@ operation fails and upon subsequently checking the channel state, it is @FAILED@), then the room will transition to the @FAILED@ status. The detach operation continues until, for every channel, either a call to @detach()@ has succeeded, or the channel enters the @FAILED@ state, with the operation throwing an @ErrorInfo@ with the feature-specific error code of the first feature to fail, using the error returned by the call to @detach()@ as the @cause@. The same @ErrorInfo@ must accompany the @FAILED@ room status.
*** @(CHA-RL2h2)@ @[Testable]@ If the room is already in a @FAILED@ status during the detach operation and another channel fails, the @FAILED@ status will not be emitted twice.
*** @(CHA-RL2h3)@ @[Testable]@ A channel may enter another state during detachment (namely @ATTACHED@, which happens when detach times out), whereby the call to @detach()@ on the realtime channel will throw an error and the channel status can be ascertained by inspecting the channel object. If this happens, the @CHA-RL2f@ detachment cycle shall be retried after a 250ms pause. The room status shall not change during this retry process.
** @(CHA-RL2i)@ @[Testable]@ If a room lifecycle operation is already in progress, this operation shall wait until the current operation completes before continuing, subject to @CHA-RL7@.
* @(CHA-RL3)@ A room must be explicitly released via the @RELEASE@ operation. This operation is not performed directly on a Room object by the client, but is described here.
** @(CHA-RL3a)@ @[Testable]@ If the room is already in the @RELEASED@ status, this operation is no-op.
** @(CHA-RL3b)@ @[Testable]@ If the room is in the @DETACHED@ status, then the room is immediately transitioned to @RELEASED@ and the operation succeeds.
** @(CHA-RL3j)@ @[Testable]@ If the room is in the @INITIALIZED@ status, then the room is immediately transitioned to @RELEASED@ and the operation succeeds.
** @(CHA-RL3c)@ This specification point has been removed.
** @(CHA-RL3i)@ This specification point has been removed.
** @(CHA-RL3l)@ @[Testable]@ When the release operation commences, the room will transition into the @RELEASING@ status and any transient disconnect timeouts shall be cleared.
** @(CHA-RL3d)@ @[Testable]@ All features channels must be detached in sequence.
** @(CHA-RL3e)@ @[Testable]@ If a channel is in the @FAILED@ state when it is time to detach, it shall be ignored.
** @(CHA-RL3f)@ @[Testable]@ If a channel fails to detach (i.e. the call to @detach()@ returns an error), the @CHA-RL3d@ channel detach sequence will be retried after a 250ms delay. Retries are continued until @CHA-RL3g@ is met.
** @(CHA-RL3g)@ @[Testable]@ Once all channels have entered the @DETACHED@ (i.e. the call to @detach()@ succeeds) or @FAILED@ (i.e. the call to @detach()@ fails and the channel state is subsequently @FAILED@) state, then the room state is transitioned to @RELEASED@ and the operation completes.
** @(CHA-RL3h)@ @[Testable]@ Upon operation completion, the underlying Realtime Channels are released from the core SDK prevent leakage.
** @(CHA-RL3k)@ @[Testable]@ If a room lifecycle operation is already in progress, this operation shall wait until the current operation completes before continuing, subject to @CHA-RL7@.
* @(CHA-RL5)@ A room must @RETRY@ whenever it enters the @SUSPENDED@ state. This specification point describes the behavior that is executed as a result of @CHA-RL4b9@ and @CHA-RL1h3@. The @RETRY@ operation is summarized as a loop that terminates either when a realtime channel enters the @FAILED@ state, or all channels are back in @ATTACHED@.
** @(CHA-RL5a)@ @[Testable]@ When entering a @RETRY@ operation, the room must first @DETACH@ all contributors underlying realtime channels using a @CHA-RL2f@ detachment cycle, with the exception of the channel that became @SUSPENDED@.
*** @(CHA-RL5a1)@ @[Testable]@ As many chat features share channels, the equality of contributors when deciding not to detach is based on their realtime channel, and not the contributor themselves. i.e. if two features share a realtime channel, and that channel is suspended, then that channel should not be detached.
** @(CHA-RL5b)@ This specification point has been removed.
** @(CHA-RL5c)@ @[Testable]@ If the operation above fails (i.e. the call to the @CHA-RL2f@ detach procedure fails), such that the room enters the @FAILED@ state, then the retry loop must stop.
** @(CHA-RL5d)@ Once all channels (except the channel that entered @SUSPENDED@, per @CHA-RL5a@) have been detached, the room waits until the original channel that caused the retry loop naturally enters the @ATTACHED@ state. Automatic re-attachment is handled by the underlying Realtime SDK. Upon completion of the @CHA-RL5a@ detach procedure, the SDK must check if the channel has already entered a new state. If not, it shall subscribe to channel state updates to be notified.
** @(CHA-RL5e)@ @[Testable]@ If, during the @CHA-RL5d@ wait, the channel state becomes @FAILED@ (either by being in that state after the @CHA-RL5a@ detach procedure completes, or via a state change event), then the room status is transitioned to @FAILED@ and the retry loop stops. The error associated with the transition is the error from the Realtime @ChannelStateChange@.
** @(CHA-RL5f)@ @[Testable]@ If, during the @CHA-RL5d@ wait, the channel state becomes @ATTACHED@ (either by being in that state after the @CHA-RL5a@ detach procedure completes, or via a state change event), then the room status is transitioned to @ATTACHING@ to begin a new @CHA-RL1e@ attachment cycle. On successful completion, or terminal condition (room status is @FAILED@) the @RETRY@ loop terminates.
*** @(CHA-RL5f1)@ This specification point has been removed. Refer to the @CHA-RL1e@ attachment cycle.
*** @(CHA-RL5f2)@ This specification point has been removed. Refer to the @CHA-RL1e@ attachment cycle.
*** @(CHA-RL5f3)@ This specification point has been removed. Refer to the @CHA-RL1e@ attachment cycle.
* @(CHA-RL6)@ This specification point has been removed. It was superseded by @CHA-RL8@.
* @(CHA-RL6a)@ This specification point has been removed. It was superseded by @CHA-RL8@.
* @(CHA-RL8)@ This specification point has been removed. It was a duplicate of @CHA-RS3@.
* @(CHA-RL7)@ Room lifecycle operations are atomic and exclusive operations: one operation must complete (whether that's failure or success) before the next one may begin.
** @(CHA-RL7a)@ @[Testable]@ Room lifecycle operations have a precedence. If multiple operations are scheduled to run, they run in the following order:
*** @(CHA-RL7a1)@ The @RETRY@ operation - an internal process.
*** @(CHA-RL7a2)@ The @RELEASE@ operation.
*** @(CHA-RL7a3)@ The @ATTACH@ and @DETACH@ operations have equal precedence.
* @(CHA-RL9)@ Many operations in the Chat SDK will still attempt to proceed if the room is in an @ATTACHING@ status. However, their ability to proceed will depend on the subsequent status that the room takes. This specification point is defined here to avoid unnecessary repetition. It is primarily testable via the points that refer to it.
** @(CHA-RL9a)@ @[Testable]@ When the room status is @ATTACHING@ at the point of operation commencement, the caller will subscribe a one-time listener to the room status.
** @(CHA-RL9b)@ @[Testable]@ If the next room status received by the caller is @ATTACHED@, the operation shall proceed as normal.
** @(CHA-RL9c)@ @[Testable]@ If the next room status received is any other value, the operation must throw an error. The @ErrorInfo@ shall have the @RoomInInvalidState@ error code from the "chat-specific error codes":#error-codes, with a status code of @500@. The @cause@ field must contain any error associated with the room status change, if present.
* @(CHA-RL10)@ @[Testable]@ When a specification point refers to operations on the underlying realtime channels (i.e. calls to attach and delete) being performed in sequence, the precedence of contributors must follow the order specified by @CHA-RC2e@.

h4(#rooms-lifecycle-monitoring). Room Lifecycle Monitoring

As well as user-initiated operations, the room must monitor its underlying resources and act accordingly. This includes handling transient or long-term disconnection from Ably, as well as discontinuities in channel messages.

* @(CHA-RL4)@ A room must monitor the state of its @contributors@ Realtime Channels and act upon any changes.
** @(CHA-RL4a)@ The state monitor must handle @UPDATE@ events from each contributors underlying Realtime Channel
*** @(CHA-RL4a1)@ @[Testable]@ If the @resumed@ flag of the update is set to @true@, then no action should be taken (i.e. @CHA-RL4a3@ and @CHA-RL4a4@ behaviours are not performed).
*** @(CHA-RL4a2)@ @[Testable]@ If the given contributor has not yet successfully managed to attach its Realtime Channel (i.e. no call to @attach()@ on the channel, per @CHA-RL1f@, has succeeded), then no action should be taken (i.e. @CHA-RL4a3@ and @CHA-RL4a4@ behaviours are not performed).
*** @(CHA-RL4a3)@ @[Testable]@ If a room lifecycle operation is in progress, then a pending discontinuity event shall be recorded for this contributor - though it must not overwrite any existing discontinuity event. The @ErrorInfo@ associated with the discontinuity shall be the @reason@ for the underlying channel state change. The event will be notified to the contributor at a later point, as noted in this specification.
*** @(CHA-RL4a4)@ @[Testable]@ If a room lifecycle operation is not in progress, then a discontinuity event will immediately be emitted to the contributor. The @ErrorInfo@ associated with the discontinuity shall be the @reason@ for the underlying channel state change.
** @(CHA-RL4b)@ The state monitor must handle non-@UPDATE@ channel state events.
*** @(CHA-RL4b1)@ @[Testable]@ If a room lifecycle operation is in progress, and the new channel state is @ATTACHED@, and the @resumed@ flag is false, @and@ the particular contributor has been attached previously (i.e. a previous call to @attach()@ on the channel, per @CHA-RL1f@, has succeeded), then a pending discontinuity event will be recorded for the contributor. The error associated with this event shall be the @reason@ for the channel state change.
*** @(CHA-RL4b2)@ This specification point has been removed.
*** @(CHA-RL4b3)@ This specification point has been removed.
*** @(CHA-RL4b4)@ This specification point has been removed.
*** @(CHA-RL4b5)@ @[Testable]@ If a room lifecycle operation is not in progress and the channel state is @FAILED@, then the room status shall be transitioned to @FAILED@, using the @reason@ for the channel state change as the @error@ for the room status change. All @transient disconnect timeouts@ are cancelled and a @CHA-RL2f@ detach procedure is performed.
*** @(CHA-RL4b6)@ This specification point has been removed.
*** @(CHA-RL4b7)@ @[Testable]@ If a room lifecycle operation is not in progress and the channel state is @ATTACHING@ and no transient disconnect timeout exists for the contributor, then a transient disconnect timeout with a 5 second limit is created for the contributor. Upon timeout, the room status is transitioned to @ATTACHING@, using the @reason@ from the initial channel state change as the error for the transition.
*** @(CHA-RL4b10)@ @[Testable]@ If a room lifecycle operation is not in progress and the channel state is @ATTACHED@ and a transient disconnect timeout exists for the contributor, the timeout is cleared.
*** @(CHA-RL4b8)@ @[Testable]@ If a room lifecycle operation is not in progress, the channel state is @ATTACHED@, the room status is NOT @ATTACHED@ and all contibutors channel are now @ATTACHED@, the room status is transitioned to @ATTACHED@.
*** @(CHA-RL4b9)@ @[Testable]@ If a room lifecycle operation is not in progress and the channel state is @SUSPENDED@, then the room status is transitioned to @SUSPENDED@, using the @reason@ of the channel state change as the error. Any transient disconnect timeouts are cancelled and the room enters the @RETRY@ loop.


h2(#room-configuration). Room Configuration

Each chat room can be configured individually, allowing options to be passed as to which features are enabled and also feature-specific settings.

* @(CHA-RC1)@ Chat Rooms are singleton objects with respect to the Chat Client on which they are created.
** @(CHA-RC1a)@ This specification point has been removed. It was superseded by CHA-RC1f.
** @(CHA-RC1f)@ @[Testable]@ Requesting a room from the Chat Client shall return a future, that eventually resolves to an instance of a room with the provided id and options.
*** @(CHA-RC1f1)@ @[Testable]@ If the room id exists in the room map, but the room has been requested with different options, then an @ErrorInfo@ with code @40000@ is thrown.
*** @(CHA-RC1f2)@ @[Testable]@ If the room id exists in the room map, and it is requested with the same options, then the same instance of the room must be reused.
*** @(CHA-RC1f3)@ @[Testable]@ If no @CHA-RC1g@ release operation is in progress, a new room instance shall be created, added to the room map and returned as the future value.
*** @(CHA-RC1f4)@ @[Testable]@ If a @CHA-RC1g@ release operation is in progress, the entry shall be added to the room map, but the new room instance must not be created until the release operation has resolved. The future shall then subsequently resolve with the new room value.
*** @(CHA-RC1f5)@ In relation to @CHA-RC1f4@, we recommend storing a future in the room map.
*** @(CHA-RC1f6)@ It should be noted that the "get" operations in this section are interruptible by a @CHA-RC1g@ release call.
** @(CHA-RC1b)@ This specification point has been removed, it was superseded by @CHA-RC1f2@
** @(CHA-RC1c)@ This specification point has been removed, it was superseded by @CHA-RC1f3@
** @(CHA-RC1d)@ This specification point has been removed.
*** @(CHA-RC1d1)@ This specification point has been removed.
** @(CHA-RC1e)@ This specification point has been removed.
** @(CHA-RC1g)@ A room may be @released@, which causes it to be disposed of and eligible for garbage collection.
*** @(CHA-RC1g1)@ The release operation returns a future that shall resolve when the operation completes. 
*** @(CHA-RC1g2)@ @[Testable]@ If the room does not exist in the room map, and no release operation is in progress, this operation is no-op.
*** @(CHA-RC1g3)@ @[Testable]@ If the room does not exist in the room map, and a release operation is already in progress, then the associated future will be returned.
*** @(CHA-RC1g4)@ @[Testable]@ If a release operation is already in progress, any pending @CHA-RC1f@ future shall be rejected / throw an error. The error must use the @RoomReleasedBeforeOperationCompleted@ error code from the "chat-specific error codes":#error-codes and a @statusCode@ of 400. The room shall be removed from the room map and the operation must return the future associated with the previous operation.
*** @(CHA-RC1g5)@ @[Testable]@ The room is removed from the room map and a @CHA-RL3@ release operation is initiated for the room object. A future is returned which resolves when the release operation completes.
* @(CHA-RC2)@ Chat rooms are configurable, so as to enable or disable certain features. When requesting a room, options as to which features should be enabled, and the configuration they should take, must be provided (@RoomOptions@).
** @(CHA-RC2a)@ @[Testable]@ If a room is requested with invalid configuration, for example: a negative typing timeout, an @ErrorInfo@ with code @40001@ must be thrown.
** @(CHA-RC2c)@ @[Testable]@ A roomâ€™s messages feature (@CHA-M*@) can not be disabled.
** @(CHA-RC2b)@ @[Testable]@ If a room is configured to have a given feature disabled, then attempting to use that feature must result in an @ErrorInfo@ with code @40000@ being thrown.
** @(CHA-RC2d)@ @[Testable]@ A room must create a lifecycle contributor for each of its enabled features and must not create a lifecycle contributor for any of its disabled features.
** @(CHA-RC2e)@ @[Testable]@ The room lifecycle contributors have an order of precedence, which is the order in which operation sequences (e.g. attaches are applied to them). The order of precedence shall be: messages, presence, typing, reactions, occupancy.
** @(CHA-RC2f)@ @[Testable]@ A room must only fetch a realtime channel if this channel is required by one of its lifecycle contributors.
* @(CHA-RC3)@ Multiple features may share one realtime channel (for example, presence and messages). Each feature may have different channel modes/options that need to be applied.
** @(CHA-RC3a)@ @[Testable]@ When retrieving a channel via @channels.get()@, features that share a channel must merge together their respective options/modes and pass the merged result to the call to @channels.get()@.
** @(CHA-RC3b)@ Note: SDKs shall not rely on updating the value progressively via feature spec item @RTS3c@ - as this has been soft-deprecated and may be removed in the future.

h2(#messages). Messages

Messages are the quintessential component of a chat room - the purpose of chat is for users to talk to each other!

Broadly speaking, messages are published via REST calls to the Chat HTTP API and message events are received in Realtime over a corresponding realtime channel.
@Messages@ shall be exposed to consumers via the @messages@ property of a @Room@.

* @(CHA-M1)@ Chat messages for a Room are sent on a corresponding realtime channel @<roomId>::$chat::$chatMessages@. For example, if your room id is @my-room@ then the messages channel will be @my-room::$chat::$chatMessages@.
* @(CHA-M2)@ A @Message@ corresponds to a single message in a chat room. This is analogous to a single user-specified message on an Ably channel (NOTE: **not** a @ProtocolMessage@).
<div class=deprecated>
** @(CHA-M2a)@ @[Testable]@ @(deprecated)@ A @Message@ is considered before another @Message@ in the global order if the @timeserial@ of the corresponding realtime channel message comes first.
** @(CHA-M2b)@ @[Testable]@ @(deprecated)@ A @Message@ is considered after another @Message@ in the global order if the @timeserial@ of the corresponding realtime channel message comes second.
** @(CHA-M2c)@ @[Testable]@ @(deprecated)@ A @Message@ is considered to be equal to another @Message@ if they have the same timeserial.
</div>
** @(CHA-M2d)@ @[Testable]@ A @Message@ contains a unique, immutable @serial@, which is a lexicographically sortable string. Global message order can be determined by a simple string comparison of the serials. The SDK must not attempt to parse timeserial strings.
** @(CHA-M2e)@ @[Testable]@ In global ordering, a @Message@ is considered to occur before another @Message@ if the @serial@ of the first @Message@ is before the latter when lexicographically sorted.
** @(CHA-M2f)@ @[Testable]@ In global ordering, a @Message@ is considered after another @Message@ if the @serial@ of the first @Message@ is after the latter when lexicographically sorted.
** @(CHA-M2g)@ @[Testable]@ Two @Messages@ are considered to be the same if they have the same @serial@, that is to say, both @Serial@ strings are identical.
* @(CHA-M10)@ A @Message@ can be modified by applying a new @action@ to it, such as an update or delete. Applying an @action@ must generate a new @Message@ instance with the same @serial@ and an updated @version@.
** @(CHA-M10a)@ @[Testable]@ The @version@ of a @Message@ is a lexicographically sortable, unique identifier for each version of the @Message@.
** @(CHA-M10b)@ This clause has been deleted.
** @(CHA-M10c)@ This clause has been deleted.
** @(CHA-M10d)@ This clause has been deleted.
** @(CHA-M10e)@ @[Testable]@ To sort @Message@ @versions@ of the same @Message@ (instances with the same @serial@) in global order, sort @Message@ instances lexicographically by their @version@ property.
*** @(CHA-M10e1)@ @[Testable]@ Two @Message@ instances of the same @serial@ are considered the same version if they have the same @version@ property.
*** @(CHA-M10e2)@ @[Testable]@ Among @Message@ instances of the same @serial@, the one with a lexicographically higher @version@ is newer.
*** @(CHA-M10e3)@ @[Testable]@ Among @Message@ instances of the same @serial@, the one with a lexicographically lower @version@ is older.
** @(CHA-M10f) @[Testable]@ A message version may be deemed older than another via the @isOlderVersionOf@ convenience method. This method returns true IFF the two messages have the same serial, and the given message is "older" by @(CHA-M10e3)@.
** @(CHA-M10g) @[Testable]@ A message version may be deemed newer than another via the @isNewerVersionOf@ convenience method. This method returns true IFF the two messages have the same serial, and the given message is "newer" by @(CHA-M10e2)@.
** @(CHA-M10h) @[Testable]@ A message version may be deemed to be the same as another via the @isSameVersionAs@ convenience method. This method returns true IFF the two messages have the same serial, and are the same version by @(CHA-M10e1)@.
* @(CHA-M3)@ A client must be able to send a message to a room.
** @(CHA-M3f)@ @[Testable]@ A client may send a message via the Chat REST API.
** @(CHA-M3a)@ @[Testable]@ When a message is sent successfully via the Chat REST API, the caller shall receive a struct representing the "@Message@":#chat-structs-message in response, as if it were received via Realtime event.
** @(CHA-M3b)@ @[Testable]@ A message may be sent via the Chat REST API without @metadata@ or @headers@. When these are not specified by the user, they must be omitted from the REST payload.
** @(CHA-M3c)@ This clause has been deleted.
** @(CHA-M3d)@ This clause has been deleted.
** @(CHA-M3e)@ @[Testable]@ If an error is returned from the REST API, its @ErrorInfo@ representation shall be thrown as the result of the @send@ call.
* @(CHA-M8)@ A client must be able to update a message in a room.
** @(CHA-M8a)@ @[Testable]@ A client may update a message via the Chat REST API by calling the @update@ method.
** @(CHA-M8b)@ @[Testable]@ When a message is updated successfully via the REST API, the caller shall receive a struct representing the "@Message@":#chat-structs-message-v2 in response, as if it were received via Realtime event.
** @(CHA-M8c)@ @[Testable]@ An update operation has PUT semantics. If a field is not specified in the update, it is assumed to be removed.
** @(CHA-M8d)@ @[Testable]@ If an error is returned from the REST API, its @ErrorInfo@ representation must be thrown as the result of the @update@ call.
* @(CHA-M9)@ A client must be able to delete a message in a room.
** @(CHA-M9a)@ @[Testable]@ A client may delete a message via the Chat REST API by calling the @delete@ method.
** @(CHA-M9b)@ @[Testable]@ When a message is deleted successfully via the REST API, the caller shall receive a struct representing the "@Message@":#chat-structs-message-v2 in response, as if it were received via Realtime event.
** @(CHA-M9c)@ @[Testable]@ If an error is returned from the REST API, its @ErrorInfo@ representation must be thrown as the result of the @delete@ call.
* @(CHA-M4)@ Messages can be received via a subscription in realtime.
** @(CHA-M4a)@ @[Testable]@ A subscription can be registered to receive incoming messages. Adding a subscription has no side effects on the status of the room or the underlying realtime channel.
** @(CHA-M4b)@ @[Testable]@ A subscription can de-registered from incoming messages. Removing a subscription has no side effects on the status of the room or the underlying realtime channel.

<div class=deprecated>
** @(CHA-M4c)@ @[Testable]@ @(deprecated)@ When a realtime message with @name@ set to @message.created@  is received, it is translated into a message event, which contains a @type@ field with the event type as well as a @message@ field containing the "@Message Struct@":#chat-structs-message. This event is then broadcast to all subscribers.
</div>

** @(CHA-M4l)@ When a realtime message with the @name@ field set to @chat.message@ is received, it shall be translated into a message event based on its @action@. This message event contains a @type@ field with the event type as well as a @message@ field containing the "@Message Struct@":#chat-structs-message-v2. This event shall then broadcast to all subscribers.
** @(CHA-M4d)@ @[Testable]@ If a realtime message with an unknown @name@ is received, the SDK shall silently discard the message, though it may log at @DEBUG@ or @TRACE@ level.
** @(CHA-M4m)@ @[Testable]@ The @action@ field of the realtime message determines the type of chat message event that is emitted, based on the following rules.
*** @(CHA-M4m1)@ @[Testable]@ If @action@ is set to @MESSAGE_CREATE@, then an event with @type@ set to @message.created@ shall be emitted.
*** @(CHA-M4m2)@ @[Testable]@ If @action@ is set to @MESSAGE_UPDATE@, then an event with @type@ set to @message.updated@ shall be emitted.
*** @(CHA-M4m3)@ @[Testable]@ If @action@ is set to @MESSAGE_DELETE@, then an event with @type@ set to @message.deleted@ shall be emitted.
*** @(CHA-M4m4)@ @[Testable]@ If a realtime message with an unknown @action@ is received, the SDK shall silently discard the message, though it may log at @DEBUG@ or @TRACE@ level.
** @(CHA-M5k)@ @[Testable]@ Incoming realtime events that are malformed (unknown field should be ignored) shall not be emitted to subscribers.
* @(CHA-M5)@ For a given subscription, messages prior to the point of subscription can be retrieved in a history-like request. Note that this is the point in the message flow @(subscription point)@ at which the subscription was made, NOT the channel attachment point.
** @(CHA-M5a)@ @[Testable]@ If a subscription is added when the underlying realtime channel is @ATTACHED@, then the @subscription point@ is the current @channelSerial@ of the realtime channel.
** @(CHA-M5b)@ @[Testable]@ If a subscription is added when the underlying realtime channel is in any other state, then its @subscription point@ becomes the @attachSerial@ at the the point of channel attachment.
** @(CHA-M5c)@ @[Testable]@ If a channel leaves the @ATTACHED@ state and then re-enters @ATTACHED@ with @resumed=false@, then it must be assumed that messages have been missed. The @subscription point@ of any subscribers must be reset to the @attachSerial@.
** @(CHA-M5d)@ @[Testable]@ If a channel @UPDATE@ event is received and @resumed=false@, then it must be assumed that messages have been missed. The @subscription point@ of any subscribers must be reset to the @attachSerial@.
** @(CHA-M5e)@ Each subscription shall expose a method or callback that allows for messages to be queried. These messages are queried via the "REST API"#rest-fetching-messages.
** @(CHA-M5f)@ @[Testable]@ This method must accept any of the standard history query options, except for @orderBy@, which must always be @newestFirst@.
** @(CHA-M5g)@ @[Testable]@ The subscribers @subscription point@ must be additionally specified (internally, by us) in the @fromSerial@ query parameter.
** @(CHA-M5h)@ @[Testable]@ The method must return a standard @PaginatedResult@ , which can be further inspected to paginate across results.
** @(CHA-M5i)@ @[Testable]@ If the REST API returns an error, then the method must throw its @ErrorInfo@ representation.
** @(CHA-M5j)@ This specification point has been removed.
* @(CHA-M6)@ Messages should be queryable from a paginated REST API.
* @(CHA-M6a)@ @[Testable]@ A method must be exposed that accepts the standard Ably REST API query parameters. It shall call the "REST API"#rest-fetching-messages and return a @PaginatedResult@ containing messages, which can then be paginated through. Each message must be represented by the standard @Message@ object.
* @(CHA-M6b)@ @[Testable]@ If the REST API returns an error, then the method must throw its @ErrorInfo@ representation.
* @(CHA-M7)@ @[Testable]@ Users may subscribe to discontinuity events to know when there's been a break in messages that they need to resolve. Their listener will be called when a discontinuity event is triggered from the room lifecycle.

h2(#reactions). Ephemeral Room Reactions

Ephemeral room reactions are one-time events that are sent to the room, such as thumbs-up or heart emojis. They are supposed to capture the current emotions in the room (e.g. everyone spamming the :tada: emoji when a team scores the winning goal).

They are ephemeral as we do not currently store these messages do not support server-authoritative counting.

All ephemeral room reactions are handled over the Realtime connection.

@Reactions@ shall be exposed to consumers via the @reactions@ property of a @Room@.

* @(CHA-ER1)@ Reactions for a Room are sent on a corresponding realtime channel @<roomId>::$chat::$reactions@. For example, if your room id is @my-room@ then the reactions channel will be @my-room::$chat::$reactions@.
* @(CHA-ER2)@ A @Reaction@ corresponds to a single reaction in a chat room. This is analogous to a single user-specified message on an Ably channel (NOTE: **not** a @ProtocolMessage@).
* @(CHA-ER3)@ Ephemeral room reactions are sent to Ably via the Realtime connection via a @send@ method.
** @(CHA-ER3a)@ @[Testable]@ Reactions are sent on the channel using a message in "this format":#realtime-room-reactions.
** @(CHA-ER3b)@ This clause has been deleted.
** @(CHA-ER3c)@ This clause has been deleted.
* @(CHA-ER4)@ A user may subscribe to reaction events in Realtime.
** @(CHA-ER4a)@ @[Testable]@ A user may provide a listener to subscribe to reaction events. This operation must have no side-effects in relation to room or underlying status. When a "realtime message":#realtime-room-reactions with name @roomReaction@ is received, this message is converted into a "reaction object":#chat-structs-ephemeral-reactions and emitted to subscribers.
** @(CHA-ER4b)@ @[Testable]@ A user may unsubscribe a registered listener. This operation must have no side-effects in relation to room or underlying status. Once unsubscribed, subsequent reaction events must not be emitted to this listener.
** @(CHA-ER4c)@ @[Testable]@ Realtime events with an unknown @name@ shall be silently discarded.
** @(CHA-ER4d)@ @[Testable]@ Realtime events that are malformed (unknown fields should be ignored) shall not be emitted to listeners.
* @(CHA-ER5)@ @[Testable]@ Users may subscribe to discontinuity events to know when there's been a break in reactions that they need to resolve. Their listener will be called when a discontinuity event is triggered from the room lifecycle.

h2(#presence). Online Status (Presence)

Presence allows chat room users to indicate to others that they're online, as well as other information including their profile picture URL etc.

@Presence@ shall be exposed to consumers via the @presence@ property of a @Room@.

* @(CHA-PR1)@ Presence for a Room is exposed on the realtime channel used for chat messages, in the format @<roomId>::$chat::$chatMessages@. For example, if your room id is @my-room@ then the presence channel will be @my-room::$chat::$chatMessages@.
* @(CHA-PR2)@ The presence payload for Chat is opinionated, so that we may add or change fields later without needing to consider how customers are using presence.
** @(CHA-PR2a)@ @[Testable]@ The presence data format is a JSON object as described below. Customers may specify an arbitrary "JSON @value@":https://www.json.org to be placed in the @userCustomData@ field.

<pre>
  {
    "userCustomData": // Any JSON `value`, does not have to be `object`. This field may be absent; see CHA-PR2b.
  }
</pre>

** @(CHA-PR2b)@ @[Testable]@ If the user performs a presence operation (@CHA-PR3a@, @CHA-PR10a@, or @CHA-PR4a@) without providing any custom data (which, for the sake of clarity, we emphasise is _not_ the same as providing the JSON @value@ of @null@ as custom data, which is handled like any other JSON @value@ per @CHA-PR2a@), then the @userCustomData@ field must be omitted from the @CHA-PR2a@ presence data that gets sent.
* @(CHA-PR3)@ Users may enter presence. The behaviour depends on the current room status, as presence operations in a Realtime Client cause implicit attaches.
** @(CHA-PR3a)@ @[Testable]@ Users may choose to enter presence, optionally providing custom data to enter with. The overall presence data must retain the format specified in @CHA-PR2@.
** @(CHA-PR3b)@ This clause has been replaced by @CHA-PR3c - CHA-PR3g@.
** @(CHA-PR3c)@ This specification point has been removed.
*** @(CHA-PR3c1) This specification point has been removed.
*** @(CHA-PR3c2)@ This specification point has been removed.
** @(CHA-PR3d)@ @[Testable]@ If the room status is @Attaching@, then the operation shall invoke a @CHA-RL9@ pending room status operation and wait for it to complete. If this operation fails, then the error from @CHA-RL9@ must be raised. If this succeeds (i.e the room becomes @ATTACHED@), the library must invoke the underlying @presence.enter()@ call.
** @(CHA-PR3h)@ @[Testable]@ If the room status is anything other than @Attached@ or @Attaching@, an @ErrorInfo@ using the @RoomInInvalidState@ error code from the "chat-specific error codes":#error-codes with a status code of @400@ must be thrown. The message shall explain that attach must be called first.
** @(CHA-PR3e)@ @[Testable]@ If the room status is @Attached@, then the @enter@ call will invoke the underlying @presence.enter()@ call.
** @(CHA-PR3f)@ This specification point has been removed. It was superseded by @CHA-PR3h@.
** @(CHA-PR3g)@ This specification point has been removed. It was superseded by @CHA-PR3h@.
* @(CHA-PR10)@ Users may update their presence data. The behaviour depends on the current room status, as presence operations in a Realtime Client cause implicit attaches.
** @(CHA-PR10a)@ @[Testable]@ Users may choose to update their presence data, optionally providing custom data to update with. The overall presence data must retain the format specified in @CHA-PR2@.
** @(CHA-PR10b)@ This clause has been replaced by @CHA-PR10c - CHA-PR10g@.
** @(CHA-PR10c)@ This specification point has been removed.
*** @(CHA-PR10c1)@ This specification point has been removed.
*** @(CHA-PR10c2)@ This specification point has been removed.
** @(CHA-PR10d)@ @[Testable]@ If the room status is @Attaching@, then the operation shall invoke a @CHA-RL9@ pending room status operation and wait for it to complete. If this operation fails, then the error from @CHA-RL9@ must be raised. If this succeeds (i.e the room becomes @ATTACHED@), the library must invoke the underlying @presence.update()@ call.
** @(CHA-PR10h)@ @[Testable]@ If the room status is anything other than @Attached@ or @Attaching@, an @ErrorInfo@ using the @RoomInInvalidState@ error code from the "chat-specific error codes":#error-codes with a status code of @400@ must be thrown. The message shall explain that attach must be called first.
** @(CHA-PR10e)@ @[Testable]@ If the room status is @Attached@, then the @update@ call will invoke the underlying @presence.enter()@ call.
** @(CHA-PR10f)@ This specification point has been removed. It was superseded by @CHA-PR10h@.
** @(CHA-PR10g)@ This specification point has been removed. It was superseded by @CHA-PR10h@.
* @(CHA-PR4)@ Users may leave presence.
** @(CHA-PR4a)@ @[Testable]@ Users may choose to leave presence, which results in them being removed from the Realtime presence set. The user may optionally provide custom data to leave with. The overall presence data must retain the format specified in @CHA-PR2@.
* @(CHA-PR5)@ @[Testable]@ It must be possible to query if a given clientId is in the presence set.
* @(CHA-PR6)@ @[Testable]@ It must be possible to retrieve all the "@Members":#chat-structs-presence-member of the presence set. The behaviour depends on the current room status, as presence operations in a Realtime Client cause implicit attaches.
** @(CHA-PR6a)@ This clause has been replaced by @CHA-PR6b - CHA-PR6f@.
** @(CHA-PR6b)@ This specification point has been removed.
*** @(CHA-PR6b1)@ This specification point has been removed.
*** @(CHA-PR6b2)@ This specification point has been removed.
** @(CHA-PR6c)@ @[Testable]@ If the room status is @Attaching@, then the operation shall invoke a @CHA-RL9@ pending room status operation and wait for it to complete. If this operation fails, then the error from @CHA-RL9@ must be raised. If this succeeds (i.e the room becomes @ATTACHED@), the library must invoke the underlying @presence.get()@ call.
** @(CHA-PR6h)@ @[Testable]@ If the room status is anything other than @Attached@ or @Attaching@, an @ErrorInfo@ using the @RoomInInvalidState@ error code from the "chat-specific error codes":#error-codes with a status code of @400@ must be thrown. The message shall explain that attach must be called first.
** @(CHA-PR6d)@ @[Testable]@ If the room status is @Attached@, then the @get@ call will invoke the underlying @presence.get()@ call.
** @(CHA-PR6e)@ This specification point has been removed. It was superseded by @CHA-PR6h@.
** @(CHA-PR6f)@ This specification point has been removed. It was superseded by @CHA-PR6h@.
* @(CHA-PR7)@ Users may subscribe to presence events.
** @(CHA-PR7a)@ @[Testable]@ Users may provide a listener to subscribe to all "presence events":#chat-structs-presence-event in a room.
** @(CHA-PR7b)@ @[Testable]@ Users may provide a listener and a list of selected "presence events":#chat-structs-presence-event, to subscribe to just those events in a room.
** @(CHA-PR7c)@ @[Testable]@ A subscription to presence may be removed, after which it shall receive no further events.
* @(CHA-PR8)@ @[Testable]@ Users may subscribe to discontinuity events to know when there's been a break in presence. Their listener will be called when a discontinuity event is triggered from the room lifecycle. For presence, there shouldn't need to be user action as the underlying core SDK will heal the presence set.
* @(CHA-PR9)@ Users may configure their presence options via the @RoomOptions@ provided at room configuration time.
** @(CHA-PR9a)@ @[Testable]@ If @enter@ is set to true, then the presence feature must set the @PRESENCE@ mode on the underlying Realtime channel. The default value is true.
** @(CHA-PR9b)@ @[Testable]@ If @subscribe@ is set to true, then presence feature must set the @PRESENCE_SUBSCRIBE@ mode on the underlying realtime channel. The default value is true. Note that setting this to false does not prevent the client from receiving its own presence messages, but it will not receive them from others.

h2(#typing). Typing Indicators

Typing Indicators allow chat room users to indicate to others that they are typing. This is most common in 1:1 and community chat, where a UI would display somthing like "Alice and Bob are typing..." to users.

This system uses ephemeral non-persisted heartbeat messages. They do not appear in channel history, resume or rewind.

@Typing Indicators@ shall be exposed to consumers via the @typing@ property of a @Room@.

For the purpose of this section, an @ephemeral message@ is understood to mean a regular message where @message.extras.ephemeral@ is set to @true@, i.e "typing-message-format":#realtime-typing-message.

* @(CHA-T1)@ This specification point has been removed. It was superseded by @CHA-T8@.
* @(CHA-T2)@ This specification point has been removed. It was replaced by @CHA-T9@.
* @(CHA-T8)@ Typing Indicators for a Room are exposed on the main room channel, in the format @<roomId>::$chat@. For example, if your room id is @my-room@ then the channel will be @my-room::$chat@.
* @(CHA-T9)@ @[Testable]@ Users must be able to retrieve a list of the currently typing client IDs through a @typing.get()@ method. The list must be a copy of the up-to-date internal list of typing client IDs.
* @(CHA-T15)@ @[Testable]@ Users must be able to provide a listener to subscribe to new typing events that the Chat client emits. This operation must have no side effects on the status of the room or the underlying realtime channel.
* @(CHA-T10)@ @[Testable]@ Users may configure a heartbeat interval (the no-op period for @typing.keystroke@ when the heartbeat timer is set active at @CHA-T4a4@). This configuration is provided at the @RoomOptions.typing.heartbeatThrottleMs@ property, or idiomatic equivalent. The default is 10000ms.
** @(CHA-T10a)@ A grace period shall be set by the client (the grace period on the @CHA-T10@ heartbeat interval when receiving events). The default value shall be set to 2000ms.
*** @(CHA-T10a1)@ This grace period is used to determine how long to wait (since the last recorded received typing event), beyond the heartbeat interval, before removing a client from the typing set. This is used to prevent flickering when a user is typing and stops typing for a short period of time. See @CHA-T13b1@ for a detailed description of how this is used.
* @(CHA-T3)@ This specification point has been removed. It was replaced by @CHA-T10@.
* @(CHA-T4)@ Users may indicate that they have started typing using the @keystroke@ method.
** @(CHA-T4d)@ @[Testable]@ If the channel state is not @ATTACHED@ or @ATTACHING@, the operation shall throw an @ErrorInfo@ with code @40000@.
** @(CHA-T4a)@ If typing is not already in progress (i.e. a heartbeat timer has not been set by the successful publish @CHA-T4a4@ of a @typing.started@ event):
*** @(CHA-T4a1)@ This specification point has been removed. It was replaced by @CHA-T4a3+@.
*** @(CHA-T4a2)@ This specification point has been removed. It was replaced by @CHA-T4a3+@.
*** @(CHA-T4a3)@ @[Testable]@ The client shall publish an ephemeral message to the channel with the @name@ field set to @typing.started@, the format of which is detailed "here":#realtime-typing-message.
*** @(CHA-T4a4)@ @[Testable]@ Upon successful publish, a heartbeat timer shall be set according to the @CHA-T10@ timeout interval.
*** @(CHA-T4a5)@ @[Testable]@ The client must wait for the publish to succeed or fail before returning the result to the caller. If the publish fails, the client must handle this transparently and re-throw the error directly to the caller.
** @(CHA-T4b)@ This specification point has been removed. It was superseded by @CHA-T4c@.
** @(CHA-T4c)@ If typing is already in progress (i.e. a heartbeat timer set according to @CHA-T4a4@ exists and has not expired):
*** @(CHA-T4c1)@ @[Testable]@ The client must not send a @typing.started@ event, instead it shall return a successful no-op to the caller.
* @(CHA-T5)@ Users may explicitly indicate that they have stopped typing using @stop@ method.
** @(CHA-T5a)@ @[Testable]@ If typing is not in progress (i.e. a @CHA-T4a4@ heartbeat timer does not exist or is expired), this operation is a no-op.
** @(CHA-T5b)@ This specification point has been removed.
** @(CHA-T5c)@ @[Testable]@ If the channel state is not @ATTACHED@ or @ATTACHING@, the operation shall throw an @ErrorInfo@ with code @40000@.
** @(CHA-T5d)@ @[Testable]@ The client shall publish an ephemeral message to the channel with the name field set to @typing.stopped@, the format of which is detailed "here":#realtime-typing-message. The client must wait for the publish to succeed or fail before returning the result to the caller.
** @(CHA-T5d1)@ @[Testable]@ The client must wait for the publish to succeed or fail before returning the result to the caller. If the publish fails, the client must handle this transparently and re-throw the error directly to the caller.
** @(CHA-T5e)@ @[Testable]@ On successfully publishing the message in @(CHA-T5d)@, the @CHA-T4a4@ timer shall be unset.
* @(CHA-T6)@ Users may subscribe to typing events - updates to a set of clientIDs that are typing. This operation, like all subscription operations, has no side-effects in relation to room lifecycle.
** @(CHA-T6a)@ @[Testable]@ Users may provide a listener to subscribe to "typing event V2":#chat-structs-typing-event-V2 in a chat room.
** @(CHA-T6b)@ @[Testable]@ A subscription to typing may be removed, after which it shall receive no further events.
** @(CHA-T6c)@ This specification point has been removed, it has been superseded by @CHA-T6d@.
*** @(CHA-T6c1)@ This specification point has been removed, it has been superseded by @CHA-T6d@.
*** @(CHA-T6c2)@ This specification point has been removed, it has been superseded by @CHA-T6d@.
* @(CHA-T13)@ When a typing event (@typing.start@ or @typing.stop@) is received from the realtime client, the Chat client shall emit appropriate events to all registered listeners @(CHA-T15)@.
** @(CHA-T13a)@ @[Testable]@ Typing events received from the server must have a valid @clientId@ and must not be malformed, i.e they must conform to the expected "payload":#realtime-typing-message (unknown fields should be ignored). Invalid events shall not be handled or emitted to any registered listeners (@CHA-T15@).
** @(CHA-T13b)@ @[Testable]@ When a typing event is received on the realtime client:
*** @(CHA-T13b1)@ @[Testable]@ If the event represents a new client typing, then the Chat client shall add the typers @clientId@ to the typing set and a emit the updated set, via a new "typing event":#chat-structs-typing-event-V2 , to any listeners. It shall also begin a timer with a timeout period that is the sum of the @CHA-T10@ heartbeat interval and the @CHA-T10a@ graÑe period.
*** @(CHA-T13b2)@ @[Testable]@ Each additional @typing.started@ event from the same client shall reset the @(CHA-T13b1)@ timer for that client.
*** @(CHA-T13b3)@ @[Testable]@ If the @(CHA-T13b1)@ timer expires, the client shall remove the @clientId@ from the typing set and emit a typing stopped event for the given client to all registered listeners (@CHA-T15@).
*** @(CHA-T13b4)@ @[Testable]@ If the event represents a client that has stopped typing, the Chat client shall remove the @clientId@ from the typing set and emit a typing stopped event to any registered listeners (@CHA-T15@). It shall also cancel the @(CHA-T13b1)@ timer for the given typing client.
*** @(CHA-T13b5)@ @[Testable]@ If the event represents a client that has stopped typing, but the @clientId@ for that client is not present in the typing set, then no stop typing event shall be emitted to any registered listeners (@CHA-T15@).
* @(CHA-T14)@ @[Testable]@ Multiple asynchronous calls to keystroke/stop typing must eventually converge to a consistent state.
** @(CHA-T14a)@ @[Testable]@ When a call to @keystroke@ or @stop@ is made, it should attempt to acquire a mutex lock.
** @(CHA-T14b)@ @[Testable]@ Once the lock is acquired, if another call is made to either function, the second call shall be queued and wait until it can acquire the lock before executing.
*** @(CHA-T14b1)@ @[Testable]@ During this time, each new subsequent call to either function shall abort the previously queued call, this should be registered as a successful no-op to the caller. In doing so, there shall only ever be one pending call while the mutex is held, thus the most recent call shall "win" and execute once the mutex is released.
*** @(CHA-T14b2)@ @[Testable]@ If an error occurs while the lock is held, the mutex shall be released and the error shall be thrown to the caller.
* @(CHA-T7)@ This specification point has been removed, it was valid up until the single-channel migration.

h2(#occupancy). Occupancy

Occupancy allows chat room users to find out how many people are currently online in the Chat Room, which is useful for showing statistics such as the viewer count in a livestream. It allows this to happen without
the overhead of having everyone in presence.

@Occupancy@ shall be exposed to consumers via the @occupancy@ property of a @Room@.

* @(CHA-O1)@ Occupancy for a room is exposed on the realtime channel used for chat messages, in the format @<roomId>::$chat::$chatMessages@. For example, if your room id is @my-room@ then the presence channel will be @my-room::$chat::$chatMessages@.
* @(CHA-O2)@ The occupancy event format is shown "here":#chat-structs-occupancy-event
* @(CHA-O3)@ @[Testable]@ Users can request an instantaneous occupancy check via the REST API. The request is detailed "here":#rest-occupancy-request, with the response format being a simple "occupancy event":#chat-structs-occupancy-event
* @(CHA-O4)@ Users can subscribe to in-band, realtime occupancy updates.
** @(CHA-O4a)@ @[Testable]@ Users may register a listener that receives occupancy events in realtime.
** @(CHA-O4b)@ @[Testable]@ A subscription to occupancy events may be removed, after which it shall receive no further events.
** @(CHA-O4c)@ @[Testable]@ When a regular occupancy event is received on the channel (a standard PubSub occupancy event per the docs), the SDK will convert it into "occupancy event":#chat-structs-occupancy-event format and broadcast it to subscribers.
** @(CHA-O4d)@ @[Testable]@ If an invalid occupancy event is received on the channel, it shall be dropped.
to typing subscribers.
* @(CHA-O5)@ @[Testable]@ Users may subscribe to discontinuity events to know when there's been a break in occupancy. Their listener will be called when a discontinuity event is triggered from the room lifecycle. For occupancy, there shouldn't need to be user action as most channels will send occupancy updates regularly as clients churn.

h2(#rest-api). Chat HTTP REST API

h3(#rest-general). General

* @(CHA-RST1)@ REST API requests shall be made via the @request()@ method on the underling Ably SDK.
* @(CHA-RST2)@ REST API requests shall use the API Protocol Version of the underlying core SDK.
* @(CHA-RST3)@ @[Testable]@ REST API requests must be supported using @JSON@ and @msgpack@ as a @Content-Type@ (@useBinaryProtocol@ on the underlying Ably SDK)

h3(#rest-sending-messages). Sending Messages

h4(#rest-sending-messages-request-v1). Request V1 @(deprecated)@

Below is the full REST payload format for the V1 endpoint. The @metadata@ and @headers@ keys are optional.

<pre>
  POST /chat/v1/rooms/<roomId>/messages
  {
    "text": "the message text",
    "metadata": {
      "foo": {
        "bar": 1
      }
    },
    "headers": {
      "baz": "qux"
    }
  }
</pre>

h4(#rest-sending-messages-request-v1). Response V1 @(deprecated)@

A successful request shall result in status code @201 Created@.

The response body is as follows.

<pre>
  {
    "timeserial": "cbfqxperABgItU52203559@1726232498871-0",
    "createdAt": 1726232498871
  }
</pre>

h4(#rest-sending-messages-request-v1). Corresponding Realtime Event V1 @(deprecated)@

<pre>
  {
    "name": "chat.message"
    "encoding": "json"
    "data": {
      "text": "the message text",
      "metadata": {
        "foo": {
          "bar": 1
        }
      }
    },
    "timestamp": "1726232498871",
    "extras": {
      "headers": {
        "baz": "qux"
      },
      "timeserial": "cbfqxperABgItU52203559@1726232498871-0"
    }
  }
</pre>

h4(#rest-sending-messages-request-v2). Request V2

Below is the full REST payload format for the V2 endpoint. The @metadata@ and @headers@ keys are optional.

<pre>
  POST /chat/v2/rooms/<roomId>/messages
  {
    "text": "the message text",
    "metadata": {
      "foo": {
        "bar": 1
      }
    },
    "headers": {
      "baz": "qux"
    }
  }
</pre>

h4(#rest-sending-messages-request-v2). Response V2

A successful request shall result in status code @201 Created@.

The response body is as follows.

<pre>
  {
    "serial": "01726585978590-001@abcdefghij:001",
    "createdAt": 1726232498871
  }
</pre>

h4(#rest-sending-messages-request-v2). Corresponding Realtime Event V2

<pre>
  {
    "name": "chat.message"
    "encoding": "json"
    "data": {
      "text": "the message text",
      "metadata": {
        "foo": {
          "bar": 1
        }
      }
    },
    "timestamp": 1726232498871,
    "createdAt": 1726232498871,
    "extras": {
      "headers": {
        "baz": "qux"
      },
    },
    "serial": "01726585978590-001@abcdefghij:001",
    "action": "message.create",
    "version": "01726585978590-001@abcdefghij:001",
    "operation": {}
  }
</pre>

h3(#rest-updating-messages). Updating Messages

h4(#rest-updating-messages-request). Request

Below is the full REST payload format for the endpoint. The @description@, @headers@ and both @metadata@ keys are optional.

<pre>
  PUT /chat/v2/rooms/<roomId>/messages/<serial>
  {
    "message": {
      "text": "the new message text",
      "metadata": {
        "foo": {
          "bar": 1
        }
      },
      "headers": {
        "baz": "qux"
      },
    },
    "description": "why-the-action-was-performed"
    "metadata": {
      "foo": "bar"
    }
  }
</pre>

h4(#rest-updating-messages-request). Response

A successful request shall result in status code @200 Ok@.

The response body is as follows.

<pre>
  {
    "version": "01726585978590-001@abcdefghij:001",
    "timestamp": 1726585978590
  }
</pre>

h4(#rest-updating-messages-request). Corresponding Realtime Event

<pre>
  {
    "name": "chat.message"
    "encoding": "json"
    "data": {
      "text": "the new message text",
      "metadata": {
        "foo": {
          "bar": 1
        }
      }
    },
    "createdAt": 1726232498871,
    "timestamp": 1726585978590,
    "extras": {
      "headers": {
        "baz": "qux"
      }
    }
    "serial": "01726232498871-001@abcdefghij:001",
    "version": "01726585978590-001@abcdefghij:001"
    "action": "message.update"
    "operation": {
      "clientId": "who-performed-the-action",
      "description": "why-the-action-was-performed"
      "metadata": {
        "foo": "bar"
      }
    }
  }
</pre>

h3(#rest-deleting-messages). Deleting Messages

h4(#rest-deleting-messages-request). Request

Below is the full REST payload format for the endpoint.

<pre>
  POST /chat/v2/rooms/<roomId>/messages/<serial>/delete
  {
    "description": "why-the-action-was-performed"
    "metadata": {
      "foo": "bar"
    }
  }
</pre>

h4(#rest-deleting-messages-request). Response

A successful request shall result in status code @200 Ok@.

The response body is as follows.

<pre>
  {
    "version": "01826232498871-001@abcdefghij:001",
    "timestamp": 1826232498871
  }
</pre>

h4(#rest-deleting-messages-request). Corresponding Realtime Event

<pre>
  {
    "name": "chat.message"
    "encoding": "json"
    "data": {
      "text": "the original message text",
      "metadata": {
        "foo": {
          "bar": 1
        }
      }
    },
    "timestamp": "1726232498871",
    "extras": {
      "headers": {
        "baz": "qux"
      },
    }
    "serial": "01726585978590-001@abcdefghij:001",
    "action": "message.deleted"
    "timestamp": 1826232498871
    "createdAt": 1726585978590,
    "version": "01826232498871-001@abcdefghij:001",
    "operation": {
      "clientId": "who-performed-the-action",
      "description": "why-the-action-was-performed"
      "metadata": {
        "foo": "bar"
      },
    }
  }
</pre>

h3(#rest-fetching-messages). Fetching Message History

h4(#rest-fetching-messages-request-v1). Request V1 @(deprecated)@

<pre>
  GET /chat/v1/rooms/<roomId>/messages
</pre>

The method accepts query parameters identical to the standard Ably REST API.

h4(#rest-fetching-messages-response). Response V1 @(deprecated)@

An array of "@Message@ structs":#chat-structs-message

h4(#rest-fetching-messages-request). Request V2

<pre>
  GET /chat/v2/rooms/<roomId>/messages
</pre>

The method accepts query parameters identical to the standard Ably REST API.

h4(#rest-fetching-messages-response). Response V2

An array of V2 "@Message@ structs":#chat-structs-message-v2

h2(#realtime-api). Chat Realtime API

This section describes the message formats for chat events that occur over a Realtime connection.

h3(#realtime-room-reactions). Ephemeral Room Reactions

<pre>
  {
    "name": "roomReaction"
    "encoding": "json"
    "data": {
      "type": ":heart:",
      "metadata": {
        "foo": {
          "bar": 1
        }
      }
    },
    "timestamp": "1726232498871", // Only on incoming messages
    "extras": {
      "headers": {
        "baz": "qux"
      },
    }
  }
</pre>

h3(#realtime-typing-message). Typing Message

<pre>
  {
    "name": "typing.started" // Required, must be either "typing.started" or "typing.stopped"
    "clientId": "who-is-typing", // Required, cannot be empty string or null - This is automatically set by the underlying pubsub SDK.
    "extras": { "ephemeral": true } // Required, must be set to true
  }
</pre>

h3(#rest-occupancy). Occupancy

h4(#rest-occupancy-request). Request

<pre>
  GET /chat/v1/rooms/<roomId>/occupancy
</pre>

h4(#rest-occupancy-response). Response

An "@OccupancyEvent@ struct":#chat-structs-occupancy


h2(#chat-structs). Chat Structs and Types

This section contains an overview of the key types in Chat. This is not intended to be prescriptive to implementation and different ecosystems may expose the underlying properties
in whichever format is most idiomatic to the platform.

h3(#chat-structs-room-options). RoomOptions

The RoomOptions struct describes configuration options for a Chat room. A property being set to a non-null value means that the feature is enabled. Some features have specific configuration.

<pre>
  {
    "presence": {
      "enter": boolean,
      "subscribe": boolean,
    },
    "typing": {
      "timeoutMs": number
    },
    "reactions": {}, // No properties, but must be non-null to enable feature.
    "occupancy": {}
  }
</pre>

h3(#chat-structs-message). Messages

h4(#chat-structs-message-v1). Messages V1 @(deprecated)@
<pre>
  {
    "timeserial": "cbfqxperABgItU52203559@1726232498871-0",
    "roomId": "my-room",
    "clientId": "who-sent-the-message",
    "text": "my-message",
    "createdAt": DateTime(),
    "metadata": {
      "foo": {
        "bar": 1
      }
    },
    "headers": {
      "baz": "qux"
    }
  }
</pre>

@(deprecated)@ Determining the global order of messages may be achieved by comparing the timeserials. See @CHA-M2@ for more information.

h4(#chat-structs-message-v2). Messages V2

<pre>
  {
    "serial": "01726585978590-001@abcdefghij:001",
    "roomId": "my-room",
    "clientId": "who-sent-the-message",
    "text": "my-message",
    "createdAt": DateTime(),
    "metadata": {
      "foo": {
        "bar": 1
      }
    },
    "headers": {
      "baz": "qux"
    }
    "action": "message.created",
    "version": "01726585978590-001@abcdefghij:001",
    "timestamp": DateTime(),
    "operation": {
        "clientId": "who-performed-the-action",
        "description": "why-the-action-was-performed"
        "metadata": {
          "foo": {
            "bar": 1
          }
        },
    }
  }
</pre>

There are getters provided in the @Message@ object to provide easy access to updated/deleted information:
* @isUpdated@ returns @true@ if the message is updated
* @isDeleted@ returns @true@ if the message is deleted
* @updatedBy@ returns the clientId from @operation.clientId@ if the message is updated, @undefined@ otherwise
* @deletedBy@ returns the clientId from @operation.clientId@ if the message is deleted, @undefined@ otherwise
* @updatedAt@ returns the @timestamp@ from the operation if the message is updated, @undefined@ otherwise
* @deletedAt@ returns the @timestamp@ from the operation if the message is deleted, @undefined@ otherwise

Determining the global order of messages may be achieved by lexicographically comparing the serials. See @CHA-M2@ for more information.

Determining the global order of message versions may be achieved by lexicographically comparing the @version@. See @CHA-M10@ for more information.

h3(#chat-structs-ephemeral-reactions). Ephemeral Room Reactions

<pre>
  {
    "type": ":heart:",
    "roomId": "my-room",
    "clientId": "who-sent-the-message",
    "createdAt": DateTime(),
    "metadata": {
      "foo": {
        "bar": 1
      }
    },
    "headers": {
      "baz": "qux"
    }
  }
</pre>

h3(#chat-structs-presence-member). Presence Member

<pre>
  {
    "clientId": "who-sent-the-message",
    "action": "enter",
    "updatedAt": DateTime(),
    "data": { â€¦ }, // A presence data object containing any user-provided data. The structure of this object is described by CHA-PR2.
    "extras": {
      "headers": {
        "baz": "qux"
      }
    }
  }
</pre>

h3(#chat-structs-presence-event). Presence Event

<pre>
  {
    "clientId": "who-is-in-presence",
    "action": "enter",
    "timestamp": DateTime(),
    "data": { â€¦ }, // A presence data object containing any user-provided data. The structure of this object is described by CHA-PR2.
  }
</pre>

h3(#chat-structs-typing-event). Typing Event @(deprecated)@

<pre>
  {
    "currentlyTyping": ["clientId-1", "clientID-2"],
  }
</pre>

h3(#chat-structs-typing-event-V2). Typing Event V2

<pre>
  {
    "change": {
        "type": "typing.started",
        "clientId": "clientId-2",
    },
    "currentlyTyping": ["clientId-1", "clientId-2"],
  }
</pre>

h3(#chat-structs-occupancy-event). Occupancy Event

<pre>
  {
    "connections": 5,
    "presenceMembers" 2,
  }
</pre>

h2(#error-codes). Chat-specific Error Codes

This section contains error codes that are specific to Chat. If a specific error code is not listed for a given circumstance, the most appropriate general error code shall be used. For example @400xx@ for client errors or @500xx@ for server errors.

For non-chat-specific codes, the status code for the error should align with the error code. For example, error code @40000@ should hav status code @400@.

<pre>
  // The message was rejected before publishing by a rule on the chat room.
  // To be accompanied by status code 422
  MessageRejectedByBeforePublishRule = 42211

  // The message was rejected before publishing by a moderation rule on the chat room.
  // To be accompanied by status code 422
  MessageRejectedByModeration = 42213

  // The messages feature failed to attach.
  // To be accompanied with status code 500.
  MessagesAttachmentFailed = 102001

  // The presence feature failed to attach.
  // To be accompanied with status code 500.
  PresenceAttachmentFailed = 102002

  // The reactions feature failed to attach.
  // To be accompanied with status code 500.
  ReactionsAttachmentFailed = 102003

  // The occupancy feature failed to attach.
  // To be accompanied with status code 500.
  OccupancyAttachmentFailed = 102004

  // The typing feature failed to attach.
  // To be accompanied with status code 500.
  TypingAttachmentFailed = 102005
  // 102006 - 102049 reserved for future use for attachment errors

  // The messages feature failed to detach.
  // To be accompanied with status code 500.
  MessagesDetachmentFailed = 102050

  // The presence feature failed to detach.
  // To be accompanied with status code 500.
  PresenceDetachmentFailed = 102051

  // The reactions feature failed to detach.
  // To be accompanied with status code 500.
  ReactionsDetachmentFailed = 102052

  // The occupancy feature failed to detach.
  // To be accompanied with status code 500.
  OccupancyDetachmentFailed = 102053

  // The typing feature failed to detach.
  // To be accompanied with status code 500.
  TypingDetachmentFailed = 102054
  // 102055 - 102099 reserved for future use for detachment errors

  // The room has experienced a discontinuity.
  // To be accompanied with status code 500.
  RoomDiscontinuity = 102100

  // Unable to perform operation;

  // Cannot perform operation because the room is in a failed state.
  // To be accompanied with status code 400.
  RoomInFailedState = 102101

  // Cannot perform operation because the room is in a releasing state.
  // To be accompanied with status code 400.
  RoomIsReleasing = 102102

  // Cannot perform operation because the room is in a released state.
  // To be accompanied with status code 400.
  RoomIsReleased = 102103

  // Cannot perform operation because the previous operation failed.
  // To be accompanied with status code 500.
  PreviousOperationFailed = 102104

  // An unknown error has happened in the room lifecycle.
  // To be accompanied with status code 500.
  RoomLifecycleError = 102105

  // Room was released before the operation could complete.
  // To be accompanied with status code 400.
  RoomReleasedBeforeOperationCompleted = 102106

  // The room operation failed because the room was in an invalid state
  // This error may be accompanied with status code 400 or 500, depending on the source of the error.
  RoomInInvalidState = 102107
</pre>
